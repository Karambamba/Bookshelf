<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    set,
    onValue,
    remove,
    update,
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD7cS8FH80HHQxsVvB76SyFgfatQq9TJuE",
    authDomain: "pixelshelf-e1680.firebaseapp.com",
    databaseURL: "https://pixelshelf-e1680-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "pixelshelf-e1680",
    storageBucket: "pixelshelf-e1680.appspot.com",
    messagingSenderId: "253121150131",
    appId: "1:253121150131:web:aa9ce817e5b8ee0ddc84c6",
    measurementId: "G-C6NMFS903Q"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.addBox = () => {
    const boxName = prompt("Назва ящика?");
    if (!boxName) return;

    const refPath = ref(db, "shelves/важливо-терміново");
    const newBox = push(refPath);
    set(newBox, {
      name: boxName,
      books: {}
    });
  };

  function loadAll() {
    const shelfRef = ref(db, "shelves");
    onValue(shelfRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      Object.keys(data).forEach((shelfKey, i) => {
        const shelfDiv = document.getElementById(`shelf-${i + 1}`);
        shelfDiv.innerHTML = "";
        shelfDiv.dataset.shelfKey = shelfKey;

        const boxes = data[shelfKey];
        for (let boxId in boxes) {
          const box = boxes[boxId];
          const boxDiv = document.createElement("div");
          boxDiv.className = "box";
          boxDiv.innerText = box.name;
          boxDiv.draggable = true;
          boxDiv.dataset.id = boxId;
          boxDiv.dataset.shelf = shelfKey;

          boxDiv.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("boxId", boxId);
            e.dataTransfer.setData("fromShelf", shelfKey);
          });

          shelfDiv.appendChild(boxDiv);
        }
      });

      // додати drop events
      document.querySelectorAll(".boxes").forEach((shelfDiv) => {
        shelfDiv.addEventListener("dragover", (e) => e.preventDefault());
        shelfDiv.addEventListener("drop", (e) => {
          e.preventDefault();
          const boxId = e.dataTransfer.getData("boxId");
          const fromShelf = e.dataTransfer.getData("fromShelf");
          const toShelf = shelfDiv.parentElement.dataset.category;

          if (!boxId || !fromShelf || !toShelf || fromShelf === toShelf) return;

          const fromRef = ref(db, `shelves/${fromShelf}/${boxId}`);
          const toRef = ref(db, `shelves/${toShelf}/${boxId}`);

          // перемістити у Firebase
          onValue(fromRef, (snap) => {
            const boxData = snap.val();
            if (!boxData) return;

            set(toRef, boxData).then(() => {
              remove(fromRef);
            });
          }, { onlyOnce: true });
        });
      });
    });
  }

  loadAll();
</script>
